---
title: 链接层
date: 2020-11-07 14:42:51
categories: BLE笔记
---
### Link Layer的作用

&emsp;&emsp;`Link Layer`的主要功能就是在这些`Physical Channel`上收发数据，并且需要控制`RF`收发相关的参数。同时，还要实现如下功能：<!--more-->
&emsp;&emsp;首先，`Physical Layer`仅仅提供了有限的`40`个`Physical Channel`，而`BLE`中参与通信的实体的数量可能会远远大于这个数字，因此`Link Layer`需要解决`Physical Channel`的共享问题。
&emsp;&emsp;其次，通信是两个实体之间的事情，对这两个实体来说，它们希望看到一条为自己独享的传输通道(就是我们所熟悉的逻辑链路，`Logical Link`)，这也是`Link Layer`需要解决的。
&emsp;&emsp;最后，`Physical Channel`是不可靠的，任何数据传输都可能受到干扰而出现损毁、丢失等问题，这对有些应用来说是接受不了的。因此`Link Layer`需要提供校验、重传等机制，确保数据传输的可靠性。

### 状态机

&emsp;&emsp;`BLE`协议在`Link Layer`抽象出`5`种状态：

1. `Standby State`
2. `Advertising State`
3. `Scanning State`
4. `Initiating State`
5. `Connection State`

并使用如下图所示的状态机进行切换：

<img src="./链接层/Link Layer的状态机.png" width=40%>

- `Standby`：初始状态，即不发送数据，也不接收数据。根据上层的命令(例如位于`Host`中的`GAP`)，可由其它任何一种状态进入，也可以切换到除`Connection`状态外的任意一种状态。
- `Advertising`：可以通过广播通道发送数据的状态，由`Standby`状态进入。它广播的数据可以由处于`Scanning`或者`Initiating`状态的实体接收。连接成功后，将切换为`Connection`状态。
- `Scanning`：可以通过广播通道接收数据的状态，由`Standby`状态进入。根据`Advertiser`所广播的数据的类型，有些`Scanner`还可以主动向`Advertiser`请求一些额外数据。上层实体可通过命令将`Scanning`状态切换回`Standby`状态。
- `Initiating`：与`Scanning`状态类似，但它是一种特殊的接收状态，由`Standby`状态进入，只能接收`Advertiser`广播的`Connectable`的数据，并在接收到数据后，发送连接请求，以便和`Advertiser`建立连接。当连接成功后，`Initiator`和对应的`Advertiser`都会切换到`Connection`状态。
- `Connection`：和某个实体建立了单独通道的状态。在通道建立之后，由`Initiating`或者`Advertising`自动切换而来。通道断开后，会重新回到`Standby`状态。

&emsp;&emsp;通道建立后(通常所说的已连接)，处于`Connection`状态的双方，分别有`2`种角色：`Master`和`Slave`。

1. `Initiator`方称作`Master`。
2. `Advertiser`方称作`Slave`。

&emsp;&emsp;在`BLE 4.2`时代，`Advertising`、`Scanning`、`Initiating`状态只允许在通道`37`、`38`和`39`上执行数据的收发。为了让发现设备和广播不容易受到`WiFi`的干扰，专门将`Advertising`、`Scanning`和`Initiating`数据收发放到了与`WiFi`频段隔离的部分，起到一定抗干扰作用：

<img src="./链接层/Advertisement Channel.png" width=60%>

&emsp;&emsp;在一个时刻，状态机只能处于一种状态，而链路层可以同时拥有多个状态机。这就意味着`BLE`设备在一个状态机中保持连接状态的同时，另一个状态机保持广播状态，或者多个链路状态机同时处于连接状态，这是`BLE`设备实现多个连接的基础。
&emsp;&emsp;以下为同时建立多个连接的场景：

1. 如果设备`A`已经跟设备`B`保持连接，那么设备`A`可以执行广播或扫描操作。
2. 如果设备`A`已经跟设备`B`保持连接，并且设备`A`是主设备，那么设备`A`能够跟其他从设备`C`再次建立连接。
3. 如果设备`A`已经跟设备`B`保持连接，并且设备`A`是从设备，那么设备`A`能够跟其他主设备`C`再次建立连接。
4. 如果设备`A`已经跟设备`B`保持连接，那么不能实现设备`A`扫描，设备`B`广播并再次建立连接。设备`A`与`B`之间只能维持一个连接状态机。