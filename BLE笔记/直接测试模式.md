---
title: 直接测试模式
date: 2020-12-09 05:22:38
categories: BLE笔记
---
&emsp;&emsp;`BLE`协议充分考虑了设备的测试问题，在协议栈层面提供了直接测试模式(`Direct Test Mode`，`DTM`)，用于执行`BLE`设备的`RF`物理层一致性的测试。<!--more-->
&emsp;&emsp;`DTM`测试的核心工作是让设备在指定的频率上发送一段数据序列，在另一端使用测试设备接收数据序列并给出测试报告；或者反过来测试设备发送一段数据序列，`BLE`设备接收并给出测试报告。
&emsp;&emsp;测试报告中会给出通信频率的偏移量、频率的功率、通信丢包率`PER`(`Packet Error Rate`)等信息，并根据这些信息判断`BLE`设备的物理层是否满足设计要求。

### 工作模式介绍

&emsp;&emsp;`DTM`测试的基本工作模式如下图所示：

&emsp;&emsp;左侧`DUT`(`Device Under Test`)表示待测设备，右侧`Upper Tester`表示上位机测试设备，通常使用`PC`；右侧`Lower Tester`表示下位机测试设备，通常是一台专业的蓝牙`RF`测试设备。
&emsp;&emsp;上位机与`DUT`之间使用串口线连接，上位机发送测试命令，`DUT`执行指定的操作，并返回执行结果。串口至少应支持以下几种波特率：`1200`、`2400`、`9600`、`14400`、`19200`、`38400`、`57600`、`115200`。
&emsp;&emsp;值得注意的是，图中`DUT`与下位机之间的连线既有实线又有虚线。实线指二者之间可以用一根同轴电缆传输`RF`信号，虚线指可以使用`RF`信号进行无线传输。使用同轴电缆需要考虑接口处的阻抗匹配和功率损耗；使用无线传输则要考虑外部射频干扰，需要在一个屏蔽箱或屏蔽室内进行测试才能保证准确。
&emsp;&emsp;如果`RF`测试设备具有串口收发能力和数据处理能力，那么该设备可以脱离`PC`独立完成全部测试任务。

### 测试内容

&emsp;&emsp;`PC`向`DUT`发送测试命令：

&emsp;&emsp;`DUT`收到命令后，会向`PC`返回事件消息：

&emsp;&emsp;发送测试的流程如下图所示：

&emsp;&emsp;接收测试的流程如下图所示：

### 命令与事件

&emsp;&emsp;命令与事件都是`2`字节数据，在串口中传输时按照`MSB`优先传输。

#### 命令

&emsp;&emsp;收发机测试命令的数据帧格式如下图所示：

&emsp;&emsp;设置测试和停止测试的命令数据帧格式如下图所示：

&emsp;&emsp;两种数据格式的首位`2 bit`都是`CMD`：

- `CMD = 00b`：该命令为`Test Setup`。
- `CMD = 01b`：该命令为`Receiver Test`。
- `CMD = 10b`：该命令为`Transmitter Test`。
- `CMD = 11b`：该命令为`Test End`。

&emsp;&emsp;1) `Test Setup`命令

- `Control = 0x00`，`Param = 0x00`：表示重置测试参数。
- `Control = 0x02`，`Param = 0x01至0x04`：设置不同的物理层。

&emsp;&emsp;2) `Test End`命令

- `Control = 0x00`，`Param = 0x00`：表示停止测试。

&emsp;&emsp;3) `Transmitter Test`命令

- `Frequency = 0x00至0x27`分别代表`0`至`39`信道频率。
- `PKT = 00b至11b`表示不同的`0/1`测试序列。
- `Length`的`低6位`表示`Payload`的数据长度。

#### 事件

&emsp;&emsp;事件只有`2`种，一种是`LE_Test_Status_Event`事件，另一种是`LE_Packet_Report_Event`事件。
&emsp;&emsp;`LE_Test_Status_Event`事件的数据帧格式如下，其中`EV = 0`，`Response`包含了状态信息。`ST`表示结果是成功还是失败。

&emsp;&emsp;`LE_Packet_Report_Event`事件的数据帧格式如下，其中`EV = 1`，`Packet Count`表示收到的数据帧总数，其有效范围是`0`至`32767`。

### 测试数据

&emsp;&emsp;当进行收发机测试时，`RF`数据格式不是标准的`BLE`数据格式，它无法被`BLE`主机扫描，仅能被`BLE`射频测试设备识别。
&emsp;&emsp;对于非编码型物理层设备，测试数据格式如下图所示：

&emsp;&emsp;对于编码型物理层设备，数据格式略有不同，增加了编码相关的字段：

&emsp;&emsp;测试时，数据不执行白化操作，不执行`CRC`计算并将其设置为常数值。前导码和`Sync Word`也均设置为固定常数值。

### LE测试数据PDU

&emsp;&emsp;`LE`测试数据`PDU`的格式如下：

&emsp;&emsp;其中`Payload`的格式如下：

&emsp;&emsp;第一部分`Payload Type`代表了测试数据的类型，可用的测试数据包括：

- `PRBS9`：`9 bit`的伪随机数。
- `PRBS15`：`15 bit`伪随机数。
- 有规则的`0/1`序列。
- `纯0`或`纯1`序列。