---
title: 设备过滤机制
date: 2020-11-21 15:19:42
categories: BLE笔记
---
&emsp;&emsp;`BLE`的广播功能还有一个问题需要引起重视：
&emsp;&emsp;如果周围有很多的`BLE`设备在广播，对`Scanner`来说，它的`Controller`会扫描到很多广播数据。如果这些数据都上报给`Host`(甚至用户)的话，估计`Host`(或者用户)会疯掉。换句话说，垃圾信息太多了，我只想看、只想听我感兴趣的。
&emsp;&emsp;于是，基于白名单(`White List`)的设备过滤机制出现了。

### 白名单(White List)

&emsp;&emsp;每一个`BLE`的`Controller`可以保存一个设备列表，可以实现设备过滤的功能，这个列表就称作白名单(`White List`)。
&emsp;&emsp;白名单的大小由`Controller`自行决定，并在`Reset`的时候清空，也可以由`Host`通过`HCI`接口进行配置。基于白名单，`Link Layer`能够实现多种设备过滤的策略：

1. `Advertising Filter Policy`
2. `Scanner Filter Policy`
3. `Initiator Filter Policy`

### Advertising Filter Policy

&emsp;&emsp;`Advertising Filter Policy`定义了`Advertiser`(处于`Advertising`状态)的`Link Layer`怎么处理`SCAN_REQ`(扫描请求)和`CONNECT_REQ`(连接请求)，包括如下策略(`Host`可以根据实际情况配置，同一时刻只能配置一种)：

- `Link Layer`只接受位于白名单中的设备的扫描和连接请求(最严格)。
- `Link Layer`可以接受任何设备的扫描和连接请求(最不严格，`Controller`在`Reset`后的默认状态)。
- `Link Layer`可以接受任何设备的扫描请求，但只接受位于白名单中的设备的连接请求。
- `Link Layer`可以接受任何设备的连接请求，但只接受位于白名单中的设备的扫描请求。

### Scanner Filter Policy

&emsp;&emsp;`Scanner Filter Policy`定一个`Scanner`(处于`Scanning`状态)的`Link Layer`怎样处理广播数据，包括如下策略：

- `Link Layer`只处理位于白名单中的设备的广播数据，并且忽略没有包括自身地址的`Connectable Directed Advertising Packet`。
- `Link Layer`处理所有设备的广播数据，并且忽略没有包括自身地址的`Connectable Directed Advertising Packet`(`Controller`在`Reset`后的默认状态)。

&emsp;&emsp;另外，如果设备支持`Extended Scanner Filter`策略，则可以同时支持如下的策略：

- `Link Layer`只处理位于白名单中的设备的广播数据，并且不能忽略`InitA`地址为`Resolvable Private Address`的`Connectable Directed Advertising packet`。
- `Link Layer`处理所有设备的广播数据，并且不能忽略`InitA`地址为`Aesolvable Private Address`的`Connectable Directed Advertising packet`。

### Initiator Filter Policy

&emsp;&emsp;`Initiator Filter Policy`定一个`Initiator`(处于`Initiating`状态)的`Link Layer`怎么处理可连接的广播数据，包括如下策略：

- `Link Layer`只处理位于白名单中的设备发送的`Connectable`广播包，并在收到的时候发起连接请求。
- 忽略白名单，`Link Layer`处理由`Host`指定的设备所发送的`Connectable`广播包，并在收到的时候发起连接请求。