---
title: TCP状态变迁图
abbrlink: 2c21c8bd
date: 2019-03-30 13:07:23
tags:
---
&emsp;&emsp;终止一个连接要经过`4`次握手，这是由于`TCP`的半关闭(`half-close`)造成的。既然一个`TCP`连接是全双工(即数据在两个方向上能同时传递，可理解为两个方向相反的独立通道)，因此每个方向必须单独地进行关闭。这原则就是当一方完成它的数据发送任务后就能发送一个`FIN`来终止这个方向连接。当一端收到一个`FIN`，内核让`read`返回`0`来通知应用层另一端已经终止了向本端的数据传送。发送`FIN`通常是应用层对`socket`进行关闭的结果。例如`TCP`客户端发送一个`FIN`，用来关闭从客户到服务器的数据传送。
&emsp;&emsp;半关闭对服务器究竟有什么影响呢？先看看下面的`TCP`状态转化图：
<!--more-->

<img src="./TCP状态变迁图/1.png" height="373" width="363">

&emsp;&emsp;首先对上面这个图示进行解释：

- `CLOSED`：表示初始状态。对服务端和客户端双方都一样。
- `LISTEN`：表示监听状态。服务端调用了`listen`函数，可以开始`accept`连接了。
- `SYN_SENT`：表示客户端已经发送了`SYN`报文。当客户端调用`connect`函数发起连接时，首先发`SYN`给服务端，然后自己进入`SYN_SENT`状态，并等待服务端发送`ACK + SYN`。
- `SYN_RCVD`：表示服务端收到客户端发送`SYN`报文。服务端收到这个报文后，进入`SYN_RCVD`状态，然后发送`ACK + SYN`给客户端。
- `ESTABLISHED`：表示连接已经建立成功了。服务端发送完`ACK + SYN`后进入该状态，客户端收到`ACK`后也进入该状态。
- `FIN_WAIT_1`：表示主动关闭连接。无论哪方调用`close`函数发送`FIN`报文都会进入这个这个状态。
- `FIN_WAIT_2`：表示被动关闭方同意关闭连接。主动关闭连接方收到被动关闭方返回的`ACK`后，会进入该状态。
- `TIME_WAIT`：表示收到对方的`FIN`报文并发送了`ACK`报文，就等`2MSL`后即可回到`CLOSED`状态了。如果`FIN_WAIT_1`状态下，收到对方同时带`FIN`标志和`ACK`标志的报文时，可以直接进入`TIME_WAIT`状态，而无须经过`FIN_WAIT_2`状态。
- `CLOSING`：表示双方同时关闭连接。如果双方几乎同时调用`close`函数，那么会出现双方同时发送`FIN`报文的情况，此时就会出现`CLOSING`状态，表示双方都在关闭连接。
- `CLOSE_WAIT`：表示被动关闭方等待关闭。当收到对方调用`close`函数发送的`FIN`报文时，回应对方`ACK`报文，此时进入`CLOSE_WAIT`状态。
- `LAST_ACK`：表示被动关闭方发送`FIN`报文后，等待对方的`ACK`报文状态，当收到`ACK`后进入`CLOSED`状态。