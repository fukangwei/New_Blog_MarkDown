---
title: FTP问题总结
date: 2019-01-16 20:42:58
categories: 网络编程
---
### FTP端口号

&emsp;&emsp;`FTP`端口号是`20`和`21`，它的端口号是可以修改的。`ftp`的控制端口一般为`21`，而数据端口不一定是`20`，这和`FTP`的应用模式有关。如果是主动模式，应该为`20`；如果为被动模式，由服务器端和客户端协商而定。<!--more-->
&emsp;&emsp;`21`端口主要用于`FTP`(`File Transfer Protocol`，文件传输协议)服务，`FTP`服务主要是为了在两台计算机之间实现文件的上传与下载，一台计算机作为`FTP`客户端，另一台计算机作为`FTP`服务器。可以采用匿名`anonymous`登录和授权用户名与密码登录两种方式登录`FTP`服务器。一个主动模式的`FTP`连接建立要遵循以下步骤：

1. 客户端打开一个随机的端口(端口号大于`1024`，在这里我们称它为`x`)，同时一个`FTP`进程连接至服务器的`21`号命令端口。此时源端口为随机端口`x`，在客户端上；远程端口为`21`，在服务器上。
2. 客户端开始监听端口(`x + 1`)，同时向服务器发送一个端口命令(通过服务器的`21`号命令端口)。此命令告诉服务器，客户端正在监听的端口号并且已准备好从此端口接收数据。这个端口就是我们所知的数据端口。
3. 服务器打开`20`号源端口并且建立和客户端数据端口的连接。此时，源端口为`20`，远程数据端口为(`x + 1`)。
4. 客户端通过本地的数据端口建立一个和服务器`20`号端口的连接，然后向服务器发送一个应答，告诉服务器它已经建立好了一个连接。

---

&emsp;&emsp;`FTP`是仅基于`TCP`的服务，不支持`UDP`。与众不同的是，`FTP`使用`2`个端口，一个数据端口和一个命令端口(也可叫做控制端口)。通常来说这两个端口是`21`(命令端口)和`20`(数据端口)。但`FTP`工作方式的不同，数据端口并不总是`20`。这就是主动与被动`FTP`的最大不同之处。

### 主动FTP

&emsp;&emsp;主动方式的`FTP`是这样的：客户端从一个任意的非特权端口`N`(`N > 1024`)连接到`FTP`服务器的命令端口，也就是`21`端口。然后客户端开始监听端口`N + 1`，并发送`FTP`命令`port N+1`到`FTP`服务器。接着服务器会从它自己的数据端口`20`连接到客户端指定的数据端口`N + 1`。针对`FTP`服务器前面的防火墙来说，必须允许以下通讯才能支持主动方式`FTP`：

- 任何大于`1024`的端口到`FTP`服务器的`21`端口(客户端初始化的连接)。
- `FTP`服务器的`21`端口到大于`1024`的端口(服务器响应客户端的控制端口)。
- `FTP`服务器的`20`端口到大于`1024`的端口(服务器端初始化数据连接到客户端的数据端口)。
- 大于`1024`端口到`FTP`服务器的`20`端口(客户端发送`ACK`响应到服务器的数据端口)。

### 被动FTP

&emsp;&emsp;为了解决服务器发起到客户的连接的问题，人们开发了一种不同的`FTP`连接方式。这就是所谓的被动方式，或者叫做`PASV`，当客户端通知服务器它处于被动模式时才启用。在被动方式`FTP`中，命令连接和数据连接都由客户端发起，这样就可以解决从服务器到客户端的数据端口的入方向连接被防火墙过滤掉的问题。
&emsp;&emsp;当开启一个`FTP`连接时，客户端打开两个任意的非特权本地端口(`N > 1024`和`N + 1`)。第一个端口连接服务器的`21`端口，但与主动方式的`FTP`不同，客户端不会提交`PORT`命令并允许服务器来回连它的数据端口，而是提交`PASV`命令。这样做的结果是服务器会开启一个任意的非特权端口(`P > 1024`)，并发送`PORT P`命令给客户端。然后客户端发起从本地端口`N + 1`到服务器的端口P的连接用来传送数据。
&emsp;&emsp;对于服务器端的防火墙来说，必须允许下面的通讯才能支持被动方式的`FTP`：

- 从任何大于`1024`的端口到服务器的`21`端口(客户端初始化的连接)。
- 服务器的`21`端口到任何大于`1024`的端口(服务器响应到客户端的控制端口的连接)。
- 从任何大于`1024`端口到服务器的大于`1024`端口(客户端初始化数据连接到服务器指定的任意端口)。
- 服务器的大于`1024`端口到远程的大于`1024`的端口(服务器发送`ACK`响应和数据到客户端的数据端口)。

### 主动与被动FTP优缺点

&emsp;&emsp;主动`FTP`对`FTP`服务器的管理有利，但对客户端的管理不利。因为`FTP`服务器企图与客户端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。被动`FTP`对`FTP`客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻塞掉。
&emsp;&emsp;幸运的是，有折衷的办法。既然`FTP`服务器的管理员需要他们的服务器有最多的客户连接，那么必须得支持被动`FTP`。我们可以通过为`FTP`服务器指定一个有限的端口范围来减小服务器高位端口的暴露。这样，不在这个范围的任何端口会被服务器的防火墙阻塞。虽然这没有消除所有针对服务器的危险，但它大大减少了危险。
&emsp;&emsp;简而言之，主动模式是从服务器端向客户端发起连接；被动模式是客户端向服务器端发起连接。两者的共同点是都使用`21`端口进行用户验证及管理，差别在于传送数据的方式不同，`PORT`模式的`FTP`服务器数据端口固定在`20`，而`PASV`模式则在`1025`至`65535`之间随机。
&emsp;&emsp;`PORT`(主动)方式的连接过程是：客户端向服务器的`FTP`端口(默认是`21`)发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，客户端在命令链路上用`PORT`命令告诉服务器`我打开了XXXX端口，你过来连接我`。于是服务器从`20`端口向客户端的`XXXX`端口发送连接请求，建立一条数据链路来传送数据。
&emsp;&emsp;`PASV`(被动)方式的连接过程是：客户端向服务器的`FTP`端口(默认是`21`)发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，服务器在命令链路上用`PASV`命令告诉客户端`我打开了XXXX端口，你过来连接我`。于是客户端向服务器的`XXXX`端口发送连接请求，建立一条数据链路来传送数据。
&emsp;&emsp;所以如果你是如果通过代理上网的话，就不能用主动模式，因为服务器敲的是上网代理服务器的门，而不是敲客户端的门。而且有时候，客户端也不是轻易就开门的，因为有防火墙阻挡，除非客户端开放大于`1024`的高端端口。