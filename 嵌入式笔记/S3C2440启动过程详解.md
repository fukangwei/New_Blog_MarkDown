---
title: S3C2440启动过程详解
date: 2019-01-17 19:14:00
categories: 嵌入式笔记
---
&emsp;&emsp;`S3C2440`是`32`位的`CPU`，所以可以寻址`4GB`空间，内存(`SDRAM`)和端口(`特殊寄存器`)，还有`ROM`都映射到同一个`4GB`空间里。开发板上一般都用`SDRAM`做内存，`flash`(`nor`或`nand`)来当做`ROM`。`nand flash`没有地址线，一次至少要读一页(`512 Byte`)，其他两个(即`SDRAM`和`nor`)有地址线。`nand flash`不用来运行代码，只用来存储代码；`nor flash`和`SDRAM`可以直接运行代码。
&emsp;&emsp;`S3C2440`总共有`8`个内存`banks`，其中`6`个内存`bank`可以当作`ROM`或者`SRAM`来使用，剩下的的`2`个`bank`除了当作`ROM`或者`SRAM`外，还可以用`SDRAM`(各种内存的读写方式不一样)。`7`个`bank`的起始地址是固定的，还有一个灵活的`bank`的内存地址，并且其`bank`大小也可以改变。
&emsp;&emsp;`S3C2440`支持两种启动模式，即`NAND`和`非NAND`(这里是`nor flash`)。具体采用的方式取决于`OM0`、`OM1`两个引脚：

- `OM[1:0] = 00`时，处理器从`NAND Flash`启动。
- `OM[1:0] = 01`时，处理器从`16`位宽度的`ROM`启动。
- `OM[1:0] = 10`时，处理器从`32`位宽度的`ROM`启动。
- `OM[1:0] = 11`时，处理器从`Test Mode`启动。

&emsp;&emsp;当从`NAND`启动时，`CPU`会自动从`NAND flash`中读取前`4KB`的数据放置在片内`SRAM`里(`s3c2440`是`SOC`)，同时把这段片内`SRAM`映射到`nGCS0`片选的空间(即`0x00000000`)。`CPU`是从`0x00000000`开始执行，也就是`NAND flash`里的前`4KB`内容。因为`NAND FLASH`连地址线都没有，不能直接把`NAND`映射到`0x00000000`，只好使用片内`SRAM`做一个载体。通过这个载体，可以把`nand flash`中大代码复制到`RAM`(一般是`SDRAM`)中去执行。
&emsp;&emsp;当从`非NAND flash`启动时，`nor flash`被映射到`0x00000000`地址(就是`nGCS0`，这里就不需要片内`SRAM`来辅助了，所以片内`SRAM`的起始地址还是`0x40000000`)，然后`cpu`从`0x00000000`开始执行(也就是在`Nor flash`中执行)。
&emsp;&emsp;`ARM`的启动都是从`0`地址开始，所不同的是地址的映射不一样。在`ARM`开电的时候，要想让`ARM`知道以某种方式(地址映射方式)运行，不可能通过你写的某段程序控制，因为这时候你的程序还没启动，这时候`ARM`会通过引脚的电平来判断。
&emsp;&emsp;当引脚`OM0`跟`OM1`有一个是高电平时，这时地址`0`会映射到外部`nGCS0`片选的空间，也就是`Nor flash`，程序就会从`Nor flash`中启动，`ARM`直接取`Nor flash`中的指令运行。
&emsp;&emsp;当`OM0`跟`OM1`都为低电平时，则地址`0`是从内部`bootbuf`(一段`4k`的`SRAM`)开始。系统上电时，`ARM`会自动把`NAND flash`中的前`4K`内容拷贝到`bootbuf`(也就是`0`地址)，然后从`0`地址运行。这时，`NAND Flash`中的前`4K`就是启动代码(它的功能就是初始化硬件，然后在把`NAND Flash`中的代码复制到`RAM`中，再把相应的指针指向该运行的地方)。
&emsp;&emsp;为什么会有这两种启动方式，关键还是两种`flash`的不同特点造成。`NOR FLASH`容量小、速度快、稳定性好，输入地址然后给出读写信号即可从数据口得到数据，适合做程序存储器；`NAND FLASH`总容量大，但是读写都需要复杂的时序，适合做数据存储器。这种不同就造成了`NOR flash`可以直接连接到ARM的总线并且可以运行程序，而`NAND flash`必须搬移到内存`SDRAM`中运行。
&emsp;&emsp;在实际的开发中，一般可以把`bootloader`烧入到`Nor flash`，程序运行可以通过串口交互，进行一定的操作，比如下载和调试。`Nor flash`中的`Bootloader`还可以具有烧录内核到`Nor flash`等功能。
&emsp;&emsp;`S3C2440`如何能能够读取不同`NAND flash`的前`4KB`内容？`S3C2440`并不是支持所有型号的`NAND FLASH`，而只要是`S3C2440`支持的，时序基本都是相同。其实读取`NAND FLASH`的`BLOCK0`的时序还是比较简单的，因为地址是固定的。
&emsp;&emsp;一般实验板的`SDRAM`挂接在`S3C2440`的`BANK6`，即地址从`0x30000000`开始。`SRAM`指的是`S3C2440`芯片的内部的内存位置，`SDRAM`指的是外接的内存位置。