---
title: BIOS工作流程
categories: 操作系统
date: 2018-12-25 20:06:03
---
&emsp;&emsp;`BIOS`(`basic input/output system`，基本输入输出系统)是一组被固化到电脑中，为电脑提供最低级、最直接的硬件控制的程序，它是连接软件程序和硬件设备的枢纽。<!--more-->

### BIOS存在的目的

&emsp;&emsp;其目的包括：检测硬件、初始化硬件、分配资源(如`IO`地址、`IRQ`号、`DMA`通道等)以及协助加载操作系统。首先了解两个概念：北桥(`north bridge`)、南桥(`south bridge`)。北桥和南桥组成了主板上的芯片组。北桥主要控制`CPU`和内存，是系统总线和一级`PCI`总线的桥接设备，也称为`host bridge`；南桥负责`PCI`、`PCI-E`、`USB`、`VGA`等外围总线设备，这些外围设备挂在`PCI`总线上，通过各自的控制器与`PCI`总线接口，不同类型的总线通过`bridge`接口。
&emsp;&emsp;在内存的低端`640KB`地址空间被称为基本内存，一般用于固定用途，如`A0000H`至`BFFFFH`保留给显卡的显存使用，`C0000H`至`C7FFFH`为显卡的`BIOS`。`C0000H`至`FFFFFH`保留给系统中各设备的`BIOS`，`IDE`、`SATA`等`BIOS`也都在这一段空间中，其中`系统BIOS`一般占用最后的`64KB`或更多(这些信息可以用`cat /proc/iomem | head`查看到)。计算机的启动过程是在主板的`BIOS`控制下进行的，这个`BIOS`也称为`系统BIOS`，它的内容在南桥芯片的一块特殊区域`CMOS`中，主板上的电池就是为`CMOS`保存资料而提供电源的。除了这个`系统BIOS`，各个`PCI`设备也都提供各自的`BIOS`，它们的功能是直接访问所在设备的`PCI`配置寄存器，以获得`PCI`设备的信息、配置`PCI`设备的参数、完成`PCI`设备的初始化等。
&emsp;&emsp;`系统BIOS`在激活时会校验`CMOS`中的资料是否正确，若正确则会将这些资料和已找到的硬件信息整合成一张表格，写到内存中，也就是所谓的`SMBIOS`(`System Management BIOS`)；若错误则用默认的值取代`CMOS`提供的资料。`SMBIOS`扮演的主要角色是将主板或`X86`架构的系统通过`BIOS`呈现在用户面前。通过`dmidecode`命令可以查看该表格，其中有许多`Type`，每个`Type`代表一类信息，可以在`dmidecode`的`man page`中找到相关定义。
&emsp;&emsp;当计算机电源开关被按下时，电源就开始向主板和其它设备供电，此时电压还不稳定，主板控制芯片组(北桥芯片)会向`CPU`发出一个`Reset`信号，让`CPU`复位初始化。当电源开始稳定供电后，芯片组便撤去`Reset`信号，`CPU`马上开始从地址`FFFF0H`处执行指令，这个地址在`系统BIOS`的地址范围内，放在这里的一般是一个跳转指令，跳到`系统BIOS`的真正开始代码处。

### BIOS经历的三个阶段

&emsp;&emsp;从主机上电到加载`bootloader`这个过程中，`系统BIOS`主要经历了三个阶段：`Pown On`、`POST`(`power on self test`)、加载`bootloader`。

- `Pown On`阶段：这一阶段从上电开始到屏幕出现信息结束，也就是所谓的激活电源阶段。这一阶段的主要任务是校验`CMOS`中的内容是否正确、检查主机上某些硬件的状态以确定下一步的自检，因此用户无法在屏幕上看到`BIOS`信息(要等硬件确认后才激活`VGA`)。若这个阶段出现错误(一般都是致命的，通常为黑屏)，只能通过喇叭声来判断错误类型。这个阶段只是检查系统上都有哪些设备，并不初始化。
- `POST`阶段：检查一些关键设备如内存、显卡能否正常工作，并提供简易的内存测试，只要测试没问题，就在屏幕上显示该硬件的基本信息。这个阶段的基本过程如下：`系统BIOS`查找显卡的`BIOS`，存放显卡`BIOS`的`ROM`芯片的起始地址通常在`C0000H`处，然后调用其初始化代码，由显卡的`BIOS`完成显卡的初始化，然后屏幕就可以显示信息了。大多数的显卡会在这时显示显卡的一些信息，但是通常只是一闪而过。同样的原理，`系统BIOS`调用在前一个阶段找到的设备的`BIOS`代码，以完成相应设备的初始化。查完其它所有设备后，`BIOS`将显示自己的启动画面，接着检查`CPU`的类型和工作频率、主机的内存容量。然后`系统BIOS`开始测试和配置系统中安装的一些标准硬件设备如硬盘、光驱、`COM`口、并口等，然后`BIOS`开始检查并配置系统中的即插即用设备。开机时和开机后所有需要用到的设备都是在这个阶段被激活的。
- 加载`bootloader`阶段：当所有的硬件都检测完毕并没有问题后，`BIOS`退居幕后的办法是将加载`OS`的主控权交给硬盘的主引导扇区`MBR`(即硬盘的物理扇区`0`柱`0`面`1`扇区上的内容)，让藏匿于此的开机管理程序(`bootloader`)将指针带到系统核心的地方。`Linux`常见的开机管理程序为`Grub`。

&emsp;&emsp;综上所述，系统激活流程为：打开电源开关 -> `CPU`初始化 -> `BIOS`激活 -> 读取并校验`CMOS`资料、检测硬件状态(此时`BIOS`代码在`flash memo`中运行) -> 生成`SMBIOS`表格 -> 检测、配置并初始化各硬件 -> 加载`bootloader`。

### 查看BIOS信息的命令

&emsp;&emsp;查看`系统BIOS`信息的命令主要有两个：`dmidecode`和`biosdecode`。它们可以显示`cpu`、内存、主板型号、`OEM`信息、主板插槽等信息，这些信息对于查看系统硬件配置非常有用。